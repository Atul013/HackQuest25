<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Registration Successful - AlertNet</title>
<link rel="stylesheet" type="text/css" href="style.css">
<style>
body {
    background: #F3F4F6;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
}

.success-container {
    text-align: center;
    max-width: 500px;
    padding: 40px;
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    animation: fadeIn 0.5s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.success-icon {
    width: 80px;
    height: 80px;
    margin: 0 auto 24px;
    background: #10B981;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: scaleIn 0.5s ease-out 0.2s both;
}

@keyframes scaleIn {
    from { transform: scale(0); }
    to { transform: scale(1); }
}

.checkmark {
    width: 40px;
    height: 40px;
    border: 4px solid white;
    border-top: none;
    border-left: none;
    transform: rotate(45deg);
    margin-top: -10px;
}

h1 {
    font-size: 28px;
    color: #1F2937;
    margin: 0 0 12px 0;
}

p {
    font-size: 16px;
    color: #6B7280;
    line-height: 1.6;
    margin: 0 0 24px 0;
}

.user-info {
    background: #F9FAFB;
    border-radius: 8px;
    padding: 20px;
    margin: 24px 0;
    text-align: left;
}

.info-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #E5E7EB;
}

.info-row:last-child {
    border-bottom: none;
}

.info-label {
    color: #6B7280;
    font-size: 14px;
}

.info-value {
    color: #1F2937;
    font-weight: 600;
    font-size: 14px;
}

.continue-btn {
    display: inline-block;
    padding: 14px 32px;
    background: #2C3E50;
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 16px;
    transition: all 0.2s;
}

.continue-btn:hover {
    background: #1A252F;
    transform: translateY(-2px);
}

.footer-note {
    margin-top: 24px;
    font-size: 13px;
    color: #9CA3AF;
}
/* Blue Header for Transcription Alerts */
.transcription-header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: #2563EB;
    color: white;
    padding: 12px 20px;
    text-align: center;
    font-weight: 500;
    z-index: 1000;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
}
</style>
</head>
<body>
    <!-- Blue Header for Live Transcription Alerts -->
    <div id="transcriptionHeader" class="transcription-header">
        ‚ö†Ô∏è Welcome to AlertNet! You will receive alerts like this.
    </div>

    <div class="success-container" style="margin-top: 60px;">
        <div class="success-icon">
            <div class="checkmark"></div>
        </div>
        
        <h1>Registration Successful!</h1>
        <p>You are now connected to the internet and registered for emergency alerts.</p>
        
        <div class="user-info" id="userInfo">
            <div class="info-row">
                <span class="info-label">Phone Number:</span>
                <span class="info-value" id="phoneDisplay">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">Alert Language:</span>
                <span class="info-value" id="languageDisplay">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">Location:</span>
                <span class="info-value" id="locationDisplay">-</span>
            </div>
            <div class="info-row" id="venueRow" style="display:none;">
                <span class="info-label">Current Venue:</span>
                <span class="info-value" id="venueDisplay">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">Background Alerts:</span>
                <span class="info-value" id="backgroundDisplay">-</span>
            </div>
        </div>
        
        <a href="https://www.google.com" class="continue-btn">Continue Browsing</a>
        
        <p class="footer-note">
            You will receive haptic alerts on your device when emergencies are announced nearby.
        </p>
    </div>
    
    <!-- Supabase JS Client for real-time alerts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // ==========================================
        // HAPTIC ALERT SERVICE
        // ==========================================
        class HapticAlertService {
          constructor() {
            this.permissions = {
              vibration: 'vibrate' in navigator,
              flash: true
            };
            
            this.morseTimings = {
              dot: 200,
              dash: 600,
              gapSymbol: 200,
              gapLetter: 600,
              gapWord: 1400
            };
            
            this.morseCode = {
              'SOS': '... --- ...',
              'ALERT': '.- .-.. . .-. -',
              'FIRE': '..-. .. .-. .',
              'EMERGENCY': '. -- . .-. --. . -. -.-. -.--'
            };
            
            this.isFlashing = false;
          }

          async triggerAlert(alertData) {
            const { severity = 'medium', type = 'general', morseMessage = 'ALERT', message = '' } = alertData;
            
            console.log('üö® ALERT RECEIVED:', message || type);
            
            // Show notification
            this.showNotificationBanner(message || type, severity);
            
            // Always vibrate for feedback
            if (this.permissions.vibration) {
              this.vibratePattern(severity);
            }
            
            // Flash screen for critical/SOS alerts
            if (severity === 'critical' || type === 'SOS' || type === 'FIRE') {
              this.flashScreen(morseMessage);
            }
          }

          showNotificationBanner(message, severity) {
            // Remove existing banner
            const existing = document.getElementById('alert-banner');
            if (existing) existing.remove();
            
            // Create banner
            const banner = document.createElement('div');
            banner.id = 'alert-banner';
            banner.style.cssText = `
              position: fixed;
              top: 20px;
              left: 20px;
              right: 20px;
              padding: 20px;
              background: ${severity === 'critical' ? '#DC2626' : severity === 'high' ? '#F59E0B' : '#3B82F6'};
              color: white;
              border-radius: 12px;
              box-shadow: 0 4px 12px rgba(0,0,0,0.3);
              z-index: 10000;
              font-size: 16px;
              font-weight: bold;
              text-align: center;
              animation: slideDown 0.3s ease-out;
            `;
            banner.textContent = `‚ö†Ô∏è ${message}`;
            document.body.appendChild(banner);
            
            // Auto-remove after 8 seconds
            setTimeout(() => {
              banner.style.animation = 'slideUp 0.3s ease-out';
              setTimeout(() => banner.remove(), 300);
            }, 8000);
          }

          vibratePattern(severity) {
            let pattern;
            
            switch (severity) {
              case 'critical':
                // SOS pattern
                pattern = [200, 100, 200, 100, 200, 300, 600, 100, 600, 100, 600, 300, 200, 100, 200, 100, 200];
                break;
              case 'high':
                // Rapid triple pulse
                pattern = [300, 200, 300, 200, 300];
                break;
              case 'medium':
                // Double pulse
                pattern = [400, 200, 400];
                break;
              case 'low':
                // Single pulse
                pattern = [500];
                break;
              default:
                pattern = [300];
            }
            
            try {
              navigator.vibrate(pattern);
              console.log('‚úì Vibration triggered:', severity);
            } catch (error) {
              console.log('Vibration not available');
            }
          }

          flashScreen(message = 'ALERT') {
            if (this.isFlashing) return;
            
            this.isFlashing = true;
            
            // Create flash overlay
            let overlay = document.getElementById('emergency-flash-overlay');
            if (!overlay) {
              overlay = document.createElement('div');
              overlay.id = 'emergency-flash-overlay';
              overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: red;
                z-index: 999999;
                pointer-events: none;
                opacity: 0;
                transition: opacity 0.1s ease;
              `;
              document.body.appendChild(overlay);
            }
            
            const morsePattern = this.morseCode[message.toUpperCase()] || this.morseCode['ALERT'];
            this.executeMorseFlash(morsePattern, overlay);
          }

          async executeMorseFlash(morsePattern, overlay) {
            const symbols = morsePattern.split(' ');
            
            for (const symbol of symbols) {
              for (const char of symbol) {
                const duration = char === '.' ? this.morseTimings.dot : this.morseTimings.dash;
                
                // Flash on
                overlay.style.opacity = '0.9';
                await this.sleep(duration);
                
                // Flash off
                overlay.style.opacity = '0';
                await this.sleep(this.morseTimings.gapSymbol);
              }
              
              await this.sleep(this.morseTimings.gapLetter);
            }
            
            // Repeat 2 more times for critical alerts
            for (let i = 0; i < 2; i++) {
              await this.sleep(this.morseTimings.gapWord);
              
              for (const symbol of symbols) {
                for (const char of symbol) {
                  const duration = char === '.' ? this.morseTimings.dot : this.morseTimings.dash;
                  overlay.style.opacity = '0.9';
                  await this.sleep(duration);
                  overlay.style.opacity = '0';
                  await this.sleep(this.morseTimings.gapSymbol);
                }
                await this.sleep(this.morseTimings.gapLetter);
              }
            }
            
            this.isFlashing = false;
            console.log('‚úì Screen flash completed');
          }

          sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
          }
        }

        // Initialize haptic service
        const hapticService = new HapticAlertService();
        console.log('‚úÖ Haptic Alert Service initialized');
        
        // Make it available globally
        window.hapticService = hapticService;
        
        // Add CSS for animations
        const style = document.createElement('style');
        style.textContent = `
          @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
          }
          @keyframes slideUp {
            from { transform: translateY(0); opacity: 1; }
            to { transform: translateY(-100%); opacity: 0; }
          }
        `;
        document.head.appendChild(style);
        
        // ==========================================
        // USER DATA DISPLAY
        // ==========================================
        // Display user information
        try {
            var userData = JSON.parse(localStorage.getItem('alertnet_user'));
            var registrationData = JSON.parse(localStorage.getItem('alertnet_registration'));
            
            if (userData) {
                document.getElementById('phoneDisplay').textContent = userData.phone || '-';
                
                var langMap = {
                    'en': 'English',
                    'hi': 'Hindi',
                    'ml': 'Malayalam',
                    'ta': 'Tamil',
                    'te': 'Telugu',
                    'kn': 'Kannada',
                    'bn': 'Bengali',
                    'mr': 'Marathi',
                    'gu': 'Gujarati',
                    'pa': 'Punjabi'
                };
                document.getElementById('languageDisplay').textContent = langMap[userData.language] || userData.language;
                
                // Location info
                if (userData.latitude && userData.longitude) {
                    document.getElementById('locationDisplay').textContent = 
                        userData.latitude.toFixed(6) + ', ' + userData.longitude.toFixed(6) + ' ‚úì';
                } else {
                    document.getElementById('locationDisplay').textContent = 'Not shared';
                }
                
                document.getElementById('backgroundDisplay').textContent = userData.backgroundAlerts ? '‚úì Enabled' : '‚úó Disabled';
            }
            
            // Show backend response (venue info, geofence status)
            if (registrationData) {
                if (registrationData.venue) {
                    document.getElementById('venueRow').style.display = 'flex';
                    document.getElementById('venueDisplay').textContent = registrationData.venue.name || 'Unknown';
                }
                
                if (registrationData.inGeofence === false) {
                    document.querySelector('.footer-note').innerHTML = 
                        '<strong>Note:</strong> You are not currently in a monitored venue. ' +
                        'Alerts will be delivered when you enter a geofenced area.';
                }
            }
        } catch(e) {
            console.log('Error loading user data:', e);
        }
        
        // ==========================================
        // DEMO ALERT AFTER REGISTRATION
        // ==========================================
        // Trigger a demo alert 3 seconds after page load
        setTimeout(function() {
            console.log('üé≠ Triggering demo alert...');
            hapticService.triggerAlert({
                severity: 'medium',
                type: 'general',
                morseMessage: 'ALERT',
                message: 'Welcome to AlertNet! You will receive alerts like this.'
            });
        }, 3000);
        
        // ==========================================
        // TEST BUTTONS (for development)
        // ==========================================
        // Expose test functions to console
        window.testCriticalAlert = function() {
            hapticService.triggerAlert({
                severity: 'critical',
                type: 'SOS',
                morseMessage: 'SOS',
                message: 'TEST: CRITICAL EMERGENCY - SOS'
            });
        };
        
        window.testFireAlert = function() {
            hapticService.triggerAlert({
                severity: 'critical',
                type: 'FIRE',
                morseMessage: 'FIRE',
                message: 'TEST: FIRE DETECTED IN YOUR AREA'
            });
        };
        
        window.testRegularAlert = function() {
            hapticService.triggerAlert({
                severity: 'high',
                type: 'general',
                morseMessage: 'ALERT',
                message: 'TEST: High priority announcement'
            });
        };
        
        console.log('');
        console.log('üß™ TEST FUNCTIONS AVAILABLE:');
        console.log('  testCriticalAlert() - Test SOS alert with red screen flash');
        console.log('  testFireAlert() - Test FIRE alert with screen flash');
        console.log('  testRegularAlert() - Test regular alert with haptic feedback');
        console.log('');

        // TRANSCRIPTION ALERT SYSTEM
        // Simple polling for transcription alerts in blue header
        let supabase;
        
        try {
            supabase = window.supabase_js.createClient(
                'https://akblmbpxxotmebzghczj.supabase.co',
                'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFrYmxtYnB4eG90bWViemdoY3pqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwNzQxMDUsImV4cCI6MjA3NTY1MDEwNX0.6d8XmmmoSh0hY8OWoymIEX7UnQU6qpgyQsyIe7_KHtI'
            );
            
            async function checkTranscriptions() {
                try {
                    const { data } = await supabase
                        .from('transcriptions')
                        .select('transcription_text, created_at')
                        .eq('is_announcement', true)
                        .order('created_at', { ascending: false })
                        .limit(1);
                    
                    if (data && data.length > 0) {
                        const header = document.getElementById('transcriptionHeader');
                        if (header) {
                            header.textContent = data[0].transcription_text;
                        }
                    }
                } catch (error) {
                    console.log('Transcription check error:', error);
                }
            }
            
            // Check every 2 seconds
            setInterval(checkTranscriptions, 2000);
            checkTranscriptions(); // Initial check
            
        } catch (error) {
            console.log('Supabase setup error:', error);
        }
    </script>
</body>
</html>
